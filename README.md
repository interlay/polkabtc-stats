# PolkaBTC Stats API

A stats API wrapping a PostgreSQL database, to aggregate and make available historic data about PolkaBTC parachain operation.

## Usage

*For the current instructions on running against a local parachain alongside the monitoring service, see the *Testing* section below.*

Ensure the proper environment variables for the PostgreSQL connection are set (`PGHOST`, `PGPORT`, `PGDATABASE`, `PGUSER`, `PGPASSWORD`).

```shell
export PGSSLMODE=require # for secure connections

yarn install
yarn build # generate the routes and run typechecking
yarn dev # start the server with file watching
```

Then navigate to `localhost:3007/docs` for the SwaggerUI, or to the defined routes to make use of the APIs.

### Deployment

Run `yarn start` instead.

## Client

For client generation, ensure `java` is in the path (this is not necessary just to run the stats server).

```shell
yarn client
```

This builds the client generated from the OpenAPI spec (which can then be published using `yarn publish`).

## Testing

To build the database from the [btc-parachain](https://github.com/interlay/btc-parachain) setup postgresql and run the
included monitoring service.

```shell
docker run --rm --name postgres \
    -p 5432:5432 \
    -e POSTGRES_USER=user \
    -e POSTGRES_PASSWORD=postgres \
    postgres:11

export PGDATABASE="postgres"
export PGUSER="user"
export PGPASSWORD="password"

MONITOR=1 yarn dev
```

To persist the database, mount a local volume on the docker container.

```shell
mkdir -p $HOME/docker/volumes/postgres
docker run --rm --name postgres \
    -p 5432:5432 \
    -e POSTGRES_USER=user \
    -e POSTGRES_PASSWORD=postgres \
    -v $HOME/docker/volumes/postgres:/var/lib/postgresql/data \
    postgres:11
```

### Usage

```typescript
import * as polkabtcStats from "@interlay/polkabtc-stats";
const statsApi = new polkabtcStats.StatsApi(new polkabtcStats.Configuration({ basePath: "http://localhost:3001" }));
const issues = (await statsApi.getTotalSuccessfulIssues()).data;
```

Autogenerated paths
---
`src/` is the only directory containing hand-written code. Do not edit files in the other directories.

* `build/` contains the OpenAPI server (including the json definition and the routes to be served), generated from the definitons in `src`. Generated using `yarn build`.
* `client/` contains the generated typescript client, as an intermediate step in packaging the client.
* `dist/` contains the compiled client, publishable as an npm package. Generated (alongside `client/`) using `yarn client`.
